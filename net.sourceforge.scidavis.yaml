app-id: net.sourceforge.scidavis
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '5.15'
command: scidavis
rename-desktop-file: scidavis.desktop
rename-icon: scidavis
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
# Open project does not work correctly without filesystem=home
  - --filesystem=home
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/doc
  - /share/man
  - '*.la'
  - '*.a'

modules:
  - shared-modules/glu/glu-9.json

  - name: muparser
    buildsystem: cmake
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/beltoforion/muparser/archive/v2.3.2.tar.gz
        sha256: b35fc84e3667d432e3414c8667d5764dfa450ed24a99eeef7ee3f6647d44f301
        x-checker-data:
          type: anitya
          project-id: 2033
          stable-only: true
          url-template: https://github.com/beltoforion/muparser/archive/v$version.tar.gz

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/4d/34/523195b783e799fd401ad4bbc40d787926dd4c61838441df08bf42297792/packaging-21.2.tar.gz
        sha256: 096d689d78ca690e4cd8a89568ba06d07ca097e3306a4381635073ca91479966
        x-checker-data:
          type: pypi
          name: packaging

  - name: python3-Pyparsing
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/39/cb/69988a9b62158c85288e7d3aeb5634efd506ca92c8a34dfae3bd2a88943a/pyparsing-3.0.5.tar.gz
        sha256: 9329d1c1b51f0f76371c4ded42c5ec4cc0be18456b22193e0570c2da98ed288b
        x-checker-data:
          type: pypi
          name: Pyparsing

  - name: python3-toml
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
        sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
        x-checker-data:
          type: pypi
          name: toml

  - name: sip
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/33/e9/27730ac17713c0a80d81d8f3bb56213f1549d96f9dc183fd16a7eec6287c/sip-5.5.0.tar.gz
        sha256: 5d024c419b30fea8a6de8c71a560c7ab0bc3c221fbfb14d55a5b865bd58eaac5

  - name: PyQt5_sip
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/b1/40/dd8f081f04a12912b65417979bf2097def0af0f20c89083ada3670562ac5/PyQt5_sip-12.9.0.tar.gz
        sha256: d3e4489d7c2b0ece9d203ae66e573939f7f60d4d29e089c9f11daa17cfeaae32
        x-checker-data:
          type: pypi
          name: PyQt5-sip

  - name: PyQt5
    build-options:
      arch:
        aarch64:
          env:
            DISABLE_GL: --disable-feature=PyQt_Desktop_OpenGL
    buildsystem: simple
    build-commands:
      - PYVER=$(python3 -c "import sys;print(sys.version_info[1])") && QMAKEPATH=/app/lib
        python3 configure.py --confirm-license --bindir=/app/bin --destdir=/app/lib/python3.${PYVER}/site-packages
        --sipdir=/app/share/sip --stubsdir=/app/lib/python3.${PYVER}/site-packages/PyQt5
        --no-designer-plugin --no-qml-plugin --no-python-dbus --no-tools --enable=QtCore
        --enable=QtGui --enable=QtNetwork --enable=QtWidgets ${DISABLE_GL}
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/3b/27/fd81188a35f37be9b3b4c2db1654d9439d1418823916fe702ac3658c9c41/PyQt5-5.15.6.tar.gz
        sha256: 80343bcab95ffba619f2ed2467fd828ffeb0a251ad7225be5fc06dcc333af452
        x-checker-data:
          type: pypi
          name: PyQt5

  - name: gsl
    config-opts:
      - --disable-static
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/gsl/gsl-2.7.tar.gz
        sha256: efbbf3785da0e53038be7907500628b466152dbc3c173a87de1b5eba2e23602b
        x-checker-data:
          type: anitya
          project-id: 1267
          stable-only: true
          url-template: https://ftp.gnu.org/gnu/gsl/gsl-$version.tar.gz

  - name: scidavis
    buildsystem: cmake
    config-opts:
      - -DSCRIPTING_PYTHON:BOOL=ON
      - -DORIGIN_IMPORT:BOOL=ON
      - -DPyQt_INCLUDE_DIR=/app/share/sip
    post-install:
      - mv /app/share/mime/packages/scidavis.xml /app/share/mime/packages/${FLATPAK_ID}.xml
      - install -Dm644 scidavis/scidavis.appdata.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml
    sources:
      - type: archive
        url: https://sourceforge.net/projects/scidavis/files/SciDAVis/2/2.4/scidavis-2.4.0.tar.gz
        sha256: 16506234115949b3f46ebfadc5add15c0d7d95367a6fb60f5042fcbf1d95e70e
        x-checker-data:
          type: anitya
          project-id: 6839
          stable-only: true
          url-template: https://sourceforge.net/projects/scidavis/files/SciDAVis/$major/$major.$minor/scidavis-$version.tar.gz
