app-id: net.sourceforge.scidavis
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: 5.15-21.08
command: scidavis
rename-desktop-file: scidavis.desktop
rename-icon: scidavis
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
# Open project does not work correctly without filesystem=home
  - --filesystem=home
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/doc
  - /share/man
  - '*.la'
  - '*.a'

modules:
  - shared-modules/glu/glu-9.json

  - name: muparser
    buildsystem: cmake
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/beltoforion/muparser/archive/v2.3.3-1.tar.gz
        sha256: 91d26d8274ae9cd9c776ee58250aeddc6b574f369eafd03b25045b858a2b8177
        x-checker-data:
          type: anitya
          project-id: 2033
          stable-only: true
          url-template: https://github.com/beltoforion/muparser/archive/v$version.tar.gz

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/df/9e/d1a7217f69310c1db8fdf8ab396229f55a699ce34a203691794c5d1cad0c/packaging-21.3.tar.gz
        sha256: dd47c42927d89ab911e606518907cc2d3a1f38bbd026385970643f9c5b8ecfeb
        x-checker-data:
          type: pypi
          name: packaging

  - name: python3-Pyparsing
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/31/df/789bd0556e65cf931a5b87b603fcf02f79ff04d5379f3063588faaf9c1e4/pyparsing-3.0.8.tar.gz
        sha256: 7bf433498c016c4314268d95df76c81b842a4cb2b276fa3312cfb1e1d85f6954
        x-checker-data:
          type: pypi
          name: Pyparsing

  - name: python3-toml
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
        sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
        x-checker-data:
          type: pypi
          name: toml

  - name: sip
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/33/e9/27730ac17713c0a80d81d8f3bb56213f1549d96f9dc183fd16a7eec6287c/sip-5.5.0.tar.gz
        sha256: 5d024c419b30fea8a6de8c71a560c7ab0bc3c221fbfb14d55a5b865bd58eaac5

  - name: PyQt5_sip
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c0/86/6b60c6a1b1d10524ed50fc4c6a2989492512bd46292a711318a53b243774/PyQt5_sip-12.9.1.tar.gz
        sha256: 2f24f299b44c511c23796aafbbb581bfdebf78d0905657b7cee2141b4982030e
        x-checker-data:
          type: pypi
          name: PyQt5-sip

  - name: PyQt5
    build-options:
      arch:
        aarch64:
          env:
            DISABLE_GL: --disable-feature=PyQt_Desktop_OpenGL
    buildsystem: simple
    build-commands:
      - PYVER=$(python3 -c "import sys;print(sys.version_info[1])") && QMAKEPATH=/app/lib
        python3 configure.py --confirm-license --bindir=/app/bin --destdir=/app/lib/python3.${PYVER}/site-packages
        --sipdir=/app/share/sip --stubsdir=/app/lib/python3.${PYVER}/site-packages/PyQt5
        --no-designer-plugin --no-qml-plugin --no-python-dbus --no-tools --enable=QtCore
        --enable=QtGui --enable=QtNetwork --enable=QtWidgets ${DISABLE_GL}
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/3b/27/fd81188a35f37be9b3b4c2db1654d9439d1418823916fe702ac3658c9c41/PyQt5-5.15.6.tar.gz
        sha256: 80343bcab95ffba619f2ed2467fd828ffeb0a251ad7225be5fc06dcc333af452
        x-checker-data:
          type: pypi
          name: PyQt5

  - name: gsl
    config-opts:
      - --disable-static
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/gsl/gsl-2.7.1.tar.gz
        sha256: dcb0fbd43048832b757ff9942691a8dd70026d5da0ff85601e52687f6deeb34b
        x-checker-data:
          type: anitya
          project-id: 1267
          stable-only: true
          url-template: https://ftp.gnu.org/gnu/gsl/gsl-$version.tar.gz

  - name: scidavis
    buildsystem: cmake
    config-opts:
      - -DSCRIPTING_PYTHON:BOOL=ON
      - -DORIGIN_IMPORT:BOOL=ON
      - -DPyQt_INCLUDE_DIR=/app/share/sip
    post-install:
      - mv /app/share/mime/packages/scidavis.xml /app/share/mime/packages/${FLATPAK_ID}.xml
      - install -Dm644 scidavis/scidavis.appdata.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml
    sources:
      - type: archive
        url: https://sourceforge.net/projects/scidavis/files/SciDAVis/2/2.7/scidavis-2.7.tar.gz
        sha256: 3687b58be4d15f8500414aa78195a27bb1795caaa15ff328b253147ef58c8fe2
        x-checker-data:
          type: anitya
          project-id: 6839
          stable-only: true
          url-template: https://sourceforge.net/projects/scidavis/files/SciDAVis/$major/$major.$minor/scidavis-$version.tar.gz
